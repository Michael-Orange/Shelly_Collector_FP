CLARIFICATION DE LA STRUCTURE
Tables nÃ©cessaires :
1ï¸âƒ£ pump_models (nouvelle table - catalogue de rÃ©fÃ©rence)
CREATE TABLE pump_models (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  power_kw REAL NOT NULL,
  current_ampere REAL NOT NULL,
  flow_rate_hmt8 REAL NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
â†’ Contient les modÃ¨les de rÃ©fÃ©rence (Pedrollo VXM 10/35, DM/8, etc.)
2ï¸âƒ£ device_config (table existante - Ã  modifier)
-- Structure actuelle (probable) :
device_id TEXT
channel TEXT
name TEXT

-- Ã€ ajouter :
+ pump_model_id INTEGER REFERENCES pump_models(id)
â†’ Lie chaque channel d'un device Ã  un modÃ¨le de pompe
ğŸ“‹ BRIEF ADAPTÃ‰ Ã€ TON ARCHITECTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ BRIEF FONCTIONNEL : Gestion des modÃ¨les de pompes
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ OBJECTIF
1. CrÃ©er un catalogue de modÃ¨les de pompes (table pump_models)
2. Permettre la sÃ©lection du modÃ¨le depuis /admin
3. Ajouter une page /admin/pumps pour gÃ©rer les modÃ¨les (CRUD)

âš ï¸ ARCHITECTURE ACTUELLE Ã€ RESPECTER
- CSS et JavaScript INLINE dans les fonctions render_*()
- Table device_config existante (Ã  modifier)
- Pattern de rendu similaire Ã  render_dashboard() et render_admin()

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š STRUCTURE DE DONNÃ‰ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1ï¸âƒ£ NOUVELLE TABLE : pump_models
----------------------------------
```sql
CREATE TABLE IF NOT EXISTS pump_models (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  power_kw REAL NOT NULL,
  current_ampere REAL NOT NULL,
  flow_rate_hmt8 REAL NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
DonnÃ©es initiales (Ã  insÃ©rer au dÃ©marrage) :
INSERT OR IGNORE INTO pump_models (id, name, power_kw, current_ampere, flow_rate_hmt8) 
VALUES 
  (1, 'Pedrollo VXM 10/35', 0.75, 4.8, 18.0),
  (2, 'Pedrollo DM/8', 0.55, 3.2, NULL);
2ï¸âƒ£ MODIFIER TABLE EXISTANTE : device_config
ALTER TABLE device_config ADD COLUMN pump_model_id INTEGER;
Structure finale de device_config :
device_id (TEXT)
channel (TEXT)
name (TEXT) â† Nom custom du channel (ex: "PR1", "PS")
pump_model_id (INTEGER NULL) â† Lien vers pump_models
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ BACKEND (FastAPI)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1ï¸âƒ£ ENDPOINT : GET /api/config/pump-models
Retourne la liste de tous les modÃ¨les de pompes.
@app.get("/api/config/pump-models")
async def get_pump_models():
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, name, power_kw, current_ampere, flow_rate_hmt8
        FROM pump_models
        ORDER BY name
    """)
    models = []
    for row in cursor.fetchall():
        models.append({
            "id": row[0],
            "name": row[1],
            "power_kw": row[2],
            "current_ampere": row[3],
            "flow_rate_hmt8": row[4]
        })
    return models
2ï¸âƒ£ ENDPOINT : POST /api/config/pump-model
CrÃ©e un nouveau modÃ¨le de pompe.
@app.post("/api/config/pump-model")
async def create_pump_model(data: dict):
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO pump_models (name, power_kw, current_ampere, flow_rate_hmt8)
        VALUES (?, ?, ?, ?)
    """, (
        data["name"],
        data["power_kw"],
        data["current_ampere"],
        data.get("flow_rate_hmt8")
    ))
    conn.commit()
    return {"success": True, "pump_model_id": cursor.lastrowid}
3ï¸âƒ£ ENDPOINT : PUT /api/config/pump-model/{id}
Modifie un modÃ¨le existant.
@app.put("/api/config/pump-model/{pump_id}")
async def update_pump_model(pump_id: int, data: dict):
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE pump_models 
        SET name = ?, power_kw = ?, current_ampere = ?, flow_rate_hmt8 = ?
        WHERE id = ?
    """, (
        data["name"],
        data["power_kw"],
        data["current_ampere"],
        data.get("flow_rate_hmt8"),
        pump_id
    ))
    conn.commit()
    return {"success": True}
4ï¸âƒ£ ENDPOINT : DELETE /api/config/pump-model/{id}
Supprime un modÃ¨le (avec vÃ©rification d'utilisation).
@app.delete("/api/config/pump-model/{pump_id}")
async def delete_pump_model(pump_id: int):
    conn = get_db()
    cursor = conn.cursor()
    
    # VÃ©rifier si le modÃ¨le est utilisÃ©
    cursor.execute("""
        SELECT COUNT(*) FROM device_config 
        WHERE pump_model_id = ?
    """, (pump_id,))
    count = cursor.fetchone()[0]
    
    if count > 0:
        return JSONResponse(
            status_code=400,
            content={"success": False, "error": f"Cannot delete: pump model is used by {count} channel(s)"}
        )
    
    cursor.execute("DELETE FROM pump_models WHERE id = ?", (pump_id,))
    conn.commit()
    return {"success": True}
5ï¸âƒ£ MODIFIER ENDPOINT : POST /api/config/device
Adapter pour gÃ©rer pump_model_id.
Actuellement (probable) :
@app.post("/api/config/device")
async def update_device_config(data: dict):
    # Update device_name
    # Update channel names one by one
Nouveau :
@app.post("/api/config/device")
async def update_device_config(data: dict):
    conn = get_db()
    cursor = conn.cursor()
    
    try:
        cursor.execute("BEGIN")
        
        # Update device name (si applicable)
        # ... ton code existant
        
        # Update tous les channels
        for ch in data["channels"]:
            cursor.execute("""
                INSERT OR REPLACE INTO device_config 
                (device_id, channel, name, pump_model_id)
                VALUES (?, ?, ?, ?)
            """, (
                data["device_id"],
                ch["channel"],
                ch["name"],
                ch.get("pump_model_id")
            ))
        
        cursor.execute("COMMIT")
        return {"success": True}
    except Exception as e:
        cursor.execute("ROLLBACK")
        raise e
6ï¸âƒ£ MODIFIER ENDPOINT : GET /api/config/devices
Retourner les infos pump_model pour chaque channel.
@app.get("/api/config/devices")
async def get_devices_config():
    conn = get_db()
    cursor = conn.cursor()
    
    # Ton code existant qui rÃ©cupÃ¨re les channels
    # Modifier pour joindre pump_models
    
    cursor.execute("""
        SELECT 
            dc.device_id,
            dc.channel,
            dc.name,
            dc.pump_model_id,
            pm.name as pump_name,
            pm.power_kw,
            pm.current_ampere,
            pm.flow_rate_hmt8
        FROM device_config dc
        LEFT JOIN pump_models pm ON dc.pump_model_id = pm.id
    """)
    
    # Construire la rÃ©ponse avec pump_model inclus
    # ... ton code de formatage
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¨ FRONTEND - PAGE 1 : /admin (Modifier render_admin())
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ajouter dans la fonction render_admin() :
1ï¸âƒ£ LIEN VERS GESTION DES POMPES (en haut de page)
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h1>Configuration des devices</h1>
    <a href="/admin/pumps" style="padding: 10px 20px; background: #007bff; color: white; 
       text-decoration: none; border-radius: 4px; font-weight: bold;">
        ğŸ”§ GÃ©rer les modÃ¨les de pompes
    </a>
</div>
2ï¸âƒ£ AJOUTER SELECT POUR CHAQUE CHANNEL
Pour chaque channel (switch:0, switch:1, switch:2), ajouter :
<div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <label style="width: 120px; font-weight: bold;">switch:0:</label>
    <input type="text" id="ch0-name" value="PR1" 
           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    <select id="ch0-model" 
            style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">-- Aucun modÃ¨le --</option>
        <!-- Rempli dynamiquement -->
    </select>
</div>
3ï¸âƒ£ JAVASCRIPT INLINE (dans render_admin())
<script>
let pumpModels = [];

// Charger les modÃ¨les au chargement de la page
async function loadPumpModels() {
    const response = await fetch('/api/config/pump-models');
    pumpModels = await response.json();
    
    // Populate tous les selects
    ['ch0-model', 'ch1-model', 'ch2-model'].forEach(selectId => {
        const select = document.getElementById(selectId);
        pumpModels.forEach(pump => {
            const flowInfo = pump.flow_rate_hmt8 
                ? `, ${pump.flow_rate_hmt8} mÂ³/h` 
                : '';
            const option = document.createElement('option');
            option.value = pump.id;
            option.textContent = `${pump.name} (${pump.power_kw} kW, ${pump.current_ampere} A${flowInfo})`;
            select.appendChild(option);
        });
    });
    
    // Puis charger la config actuelle
    loadCurrentConfig();
}

async function loadCurrentConfig() {
    const response = await fetch('/api/config/devices');
    const devices = await response.json();
    // PrÃ©-sÃ©lectionner les modÃ¨les actuels
    // ... ton code existant adaptÃ©
}

async function saveDeviceConfig(deviceId) {
    const channels = [
        {
            channel: 'switch:0',
            name: document.getElementById('ch0-name').value,
            pump_model_id: document.getElementById('ch0-model').value || null
        },
        {
            channel: 'switch:1',
            name: document.getElementById('ch1-name').value,
            pump_model_id: document.getElementById('ch1-model').value || null
        },
        {
            channel: 'switch:2',
            name: document.getElementById('ch2-name').value,
            pump_model_id: document.getElementById('ch2-model').value || null
        }
    ];
    
    const response = await fetch('/api/config/device', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: deviceId,
            device_name: document.getElementById('device-name').value,
            channels: channels
        })
    });
    
    if (response.ok) {
        alert('Configuration enregistrÃ©e avec succÃ¨s !');
    }
}

// Charger au dÃ©marrage
document.addEventListener('DOMContentLoaded', loadPumpModels);
</script>
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¨ FRONTEND - PAGE 2 : /admin/pumps (Nouvelle fonction render_pumps())
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CrÃ©er une nouvelle fonction similaire Ã  render_admin() :
@app.get("/admin/pumps")
async def render_admin_pumps():
    return HTMLResponse(f"""
    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Gestion des modÃ¨les de pompes</title>
        <style>
            /* RÃ©utiliser les styles de ton admin existant */
            body {{
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background: #f5f5f5;
            }}
            .container {{
                max-width: 1200px;
                margin: 0 auto;
            }}
            .btn-back {{
                padding: 10px 20px;
                background: #6c757d;
                color: white;
                text-decoration: none;
                border-radius: 4px;
                font-weight: bold;
            }}
            .pump-form-card {{
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 30px;
            }}
            .form-row {{
                margin-bottom: 20px;
            }}
            .form-row label {{
                display: block;
                font-weight: bold;
                margin-bottom: 5px;
            }}
            .form-row input {{
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }}
            table {{
                width: 100%;
                border-collapse: collapse;
                background: white;
            }}
            th, td {{
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }}
            th {{
                background: #f8f9fa;
                font-weight: bold;
            }}
            .btn-primary {{
                padding: 12px 30px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }}
            .btn-edit {{
                padding: 6px 12px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }}
            .btn-delete {{
                padding: 6px 12px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px;">
                <a href="/admin" class="btn-back">â† Retour Ã  l'admin</a>
                <h1>Gestion des modÃ¨les de pompes</h1>
            </div>

            <div class="pump-form-card">
                <h2 id="form-title">Ajouter un nouveau modÃ¨le</h2>
                <form id="pump-form" onsubmit="handleSubmit(event)">
                    <input type="hidden" id="pump-id">
                    
                    <div class="form-row">
                        <label>Nom du modÃ¨le *</label>
                        <input type="text" id="pump-name" required placeholder="Ex: Pedrollo VXM 10/35">
                    </div>
                    
                    <div class="form-row">
                        <label>Puissance (kW) *</label>
                        <input type="number" id="pump-power" step="0.01" min="0" required placeholder="Ex: 0.75">
                    </div>
                    
                    <div class="form-row">
                        <label>IntensitÃ© Ã  230V (A) *</label>
                        <input type="number" id="pump-current" step="0.1" min="0" required placeholder="Ex: 4.8">
                    </div>
                    
                    <div class="form-row">
                        <label>DÃ©bit Ã  HMT=8 (mÂ³/h)</label>
                        <input type="number" id="pump-flow" step="0.1" min="0" placeholder="Laisser vide si N/A">
                    </div>
                    
                    <button type="submit" class="btn-primary">Enregistrer</button>
                    <button type="button" class="btn-cancel" onclick="resetForm()">Annuler</button>
                </form>
            </div>

            <div class="pump-form-card">
                <h2>ModÃ¨les existants</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Puissance (kW)</th>
                            <th>IntensitÃ© (A)</th>
                            <th>DÃ©bit (mÂ³/h)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pumps-tbody"></tbody>
                </table>
            </div>
        </div>

        <script>
            let pumps = [];

            async function loadPumps() {{
                const response = await fetch('/api/config/pump-models');
                pumps = await response.json();
                renderTable();
            }}

            function renderTable() {{
                const tbody = document.getElementById('pumps-tbody');
                if (pumps.length === 0) {{
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Aucun modÃ¨le</td></tr>';
                    return;
                }}
                tbody.innerHTML = pumps.map(pump => `
                    <tr>
                        <td>${{pump.name}}</td>
                        <td>${{pump.power_kw}}</td>
                        <td>${{pump.current_ampere}}</td>
                        <td>${{pump.flow_rate_hmt8 || '-'}}</td>
                        <td>
                            <button class="btn-edit" onclick="editPump(${{pump.id}})">âœï¸ Modifier</button>
                            <button class="btn-delete" onclick="deletePump(${{pump.id}})">ğŸ—‘ï¸ Supprimer</button>
                        </td>
                    </tr>
                `).join('');
            }}

            async function handleSubmit(e) {{
                e.preventDefault();
                const pumpId = document.getElementById('pump-id').value;
                const data = {{
                    name: document.getElementById('pump-name').value,
                    power_kw: parseFloat(document.getElementById('pump-power').value),
                    current_ampere: parseFloat(document.getElementById('pump-current').value),
                    flow_rate_hmt8: document.getElementById('pump-flow').value 
                        ? parseFloat(document.getElementById('pump-flow').value) 
                        : null
                }};
                
                let response;
                if (pumpId) {{
                    response = await fetch(`/api/config/pump-model/${{pumpId}}`, {{
                        method: 'PUT',
                        headers: {{ 'Content-Type': 'application/json' }},
                        body: JSON.stringify(data)
                    }});
                }} else {{
                    response = await fetch('/api/config/pump-model', {{
                        method: 'POST',
                        headers: {{ 'Content-Type': 'application/json' }},
                        body: JSON.stringify(data)
                    }});
                }}
                
                if (response.ok) {{
                    alert(pumpId ? 'ModÃ¨le modifiÃ© !' : 'ModÃ¨le crÃ©Ã© !');
                    resetForm();
                    loadPumps();
                }}
            }}

            function editPump(id) {{
                const pump = pumps.find(p => p.id === id);
                document.getElementById('form-title').textContent = 'Modifier le modÃ¨le';
                document.getElementById('pump-id').value = pump.id;
                document.getElementById('pump-name').value = pump.name;
                document.getElementById('pump-power').value = pump.power_kw;
                document.getElementById('pump-current').value = pump.current_ampere;
                document.getElementById('pump-flow').value = pump.flow_rate_hmt8 || '';
            }}

            async function deletePump(id) {{
                if (!confirm('Supprimer ce modÃ¨le ?')) return;
                const response = await fetch(`/api/config/pump-model/${{id}}`, {{
                    method: 'DELETE'
                }});
                if (response.ok) {{
                    alert('ModÃ¨le supprimÃ© !');
                    loadPumps();
                }} else {{
                    const error = await response.json();
                    alert('Erreur : ' + error.error);
                }}
            }}

            function resetForm() {{
                document.getElementById('form-title').textContent = 'Ajouter un nouveau modÃ¨le';
                document.getElementById('pump-id').value = '';
                document.getElementById('pump-form').reset();
            }}

            loadPumps();
        </script>
    </body>
    </html>
    """)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… CHECKLIST POST-BUILD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Base de donnÃ©es :
â˜ Table pump_models crÃ©Ã©e
â˜ DonnÃ©es initiales insÃ©rÃ©es (Pedrollo VXM 10/35, DM/8)
â˜ Colonne pump_model_id ajoutÃ©e Ã  device_config
Backend :
â˜ GET /api/config/pump-models
â˜ POST /api/config/pump-model
â˜ PUT /api/config/pump-model/{id}
â˜ DELETE /api/config/pump-model/{id} (avec vÃ©rification)
â˜ POST /api/config/device modifiÃ© (gÃ¨re pump_model_id)
â˜ GET /api/config/devices modifiÃ© (JOIN pump_models)
Frontend :
â˜ /admin : Lien vers /admin/pumps
â˜ /admin : Select pour chaque channel
â˜ /admin : UN SEUL bouton Enregistrer
â˜ /admin/pumps : Page complÃ¨te avec CRUD
â˜ /admin/pumps : CrÃ©ation/modification/suppression fonctionnelle
Tests :
â˜ CrÃ©er un nouveau modÃ¨le â†’ Visible dans /admin
â˜ Modifier un modÃ¨le â†’ Changements visibles
â˜ Supprimer un modÃ¨le utilisÃ© â†’ Erreur
â˜ Supprimer un modÃ¨le non utilisÃ© â†’ OK
â˜ SÃ©lectionner un modÃ¨le dans /admin â†’ Enregistrement OK

---

## ğŸ¯ RÃ‰SUMÃ‰ ADAPTÃ‰

### **Tables** :
- âœ… `pump_models` (nouvelle) â†’ Catalogue des modÃ¨les
- âœ… `device_config` (existante + colonne `pump_model_id`)

### **Pattern suivi** :
- âœ… CSS/JS inline dans render_admin() et render_pumps()
- âœ… Pas de fichiers statiques sÃ©parÃ©s
- âœ… Structure similaire Ã  ton code existant

### **Pages** :
- âœ… `/admin` â†’ SÃ©lection modÃ¨les + lien vers gestion
- âœ… `/admin/pumps` â†’ CRUD complet (nouvelle page)

export default {
  async fetch(request, env) {
    if (request.headers.get("Upgrade") === "websocket") {
      return handleWebSocket(request, env);
    }
    return new Response("Shelly Filter Proxy - WebSocket only", { status: 200 });
  },
};

function shouldForwardMessage(data) {
  const channelsInclude = [0, 1, 2];
  const powerThreshold = 10;

  if (data && data.params) {
    for (const ch of channelsInclude) {
      const key = `switch:${ch}`;
      const sw = data.params[key];
      if (sw && typeof sw.apower === "number" && sw.apower > powerThreshold) {
        return true;
      }
    }
  }
  return false;
}

async function handleWebSocket(request, env) {
  const pair = new WebSocketPair();
  const client = pair[0];
  const server = pair[1];
  server.accept();

  console.log("Shelly connected");

  const backendUrl = env.REPLIT_WS_URL || "wss://shelly-ws-collector-sagemcom.replit.app/ws";
  
  let backend = null;
  let backendOpen = false;
  let messageQueue = [];

  function sendQueuedMessages() {
    while (messageQueue.length > 0 && backendOpen) {
      const msg = messageQueue.shift();
      try {
        backend.send(msg);
        console.log("Sent queued message to Replit");
      } catch (e) {
        console.error("Send failed:", e);
        break;
      }
    }
  }

  function ensureBackend() {
    if (backend) return;
    
    backend = new WebSocket(backendUrl);
    
    backend.addEventListener("open", () => {
      backendOpen = true;
      console.log("Backend connected");
      sendQueuedMessages();
    });
    
    backend.addEventListener("message", (ev) => {
      try {
        server.send(ev.data);
      } catch (e) {
        console.error("Relay failed:", e);
      }
    });
    
    backend.addEventListener("close", () => {
      console.log("Backend closed");
      backendOpen = false;
      backend = null;
    });
    
    backend.addEventListener("error", (e) => {
      console.error("Backend error:", e);
      backendOpen = false;
      backend = null;
    });
  }

  server.addEventListener("message", (ev) => {
    let data;
    try { 
      data = JSON.parse(ev.data); // PAS de .toString()
    } catch { 
      return; 
    }

    if (!shouldForwardMessage(data)) return;

    console.log("Message >10W detected");
    
    if (backendOpen) {
      try {
        backend.send(ev.data);
        console.log("Sent to Replit");
      } catch (e) {
        console.error("Send failed:", e);
      }
    } else {
      messageQueue.push(ev.data);
      console.log("Queued message");
      ensureBackend();
    }
  });

  server.addEventListener("close", () => {
    console.log("Shelly disconnected");
    if (backend) backend.close();
  });

  return new Response(null, { status: 101, webSocket: client });
}
ğŸ“‹ BRIEF CORRIGÃ‰ (SEULEMENT DÃ‰BIT EFFECTIF)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ BRIEF : Ajout champ "DÃ©bit effectif" uniquement
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ OBJECTIF
Ajouter un champ "DÃ©bit effectif (mÂ³/h)" dans la configuration de chaque channel.
Le champ HMT existe dÃ©jÃ  et ne doit pas Ãªtre modifiÃ©.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š BASE DE DONNÃ‰ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MODIFICATION TABLE device_config
---------------------------------
Ajouter SEULEMENT la colonne flow_rate :

```sql
ALTER TABLE device_config ADD COLUMN IF NOT EXISTS flow_rate REAL NULL;
âš ï¸ NE PAS TOUCHER Ã  la colonne hmt (existe dÃ©jÃ )
Structure device_config aprÃ¨s modification :
device_id (TEXT)
channel (TEXT)
name (TEXT)
pump_model_id (INTEGER)
hmt (REAL) â† EXISTE DÃ‰JÃ€, ne pas modifier
flow_rate (REAL NULL) â† NOUVEAU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ BACKEND - SERVICE (config_service.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1ï¸âƒ£ Modifier update_device_config()
Ajouter SEULEMENT la validation et insertion de flow_rate :
def update_device_config(conn, data):
    cursor = conn.cursor()
    
    try:
        # Validation flow_rate (NOUVEAU)
        for ch in data["channels"]:
            if ch.get("flow_rate") is not None and ch.get("flow_rate") != "":
                try:
                    flow_rate = float(ch["flow_rate"])
                    if flow_rate < 0:
                        raise ValueError(f"DÃ©bit effectif doit Ãªtre positif pour {ch['channel']}")
                except (ValueError, TypeError):
                    raise ValueError(f"DÃ©bit effectif invalide pour {ch['channel']}: {ch.get('flow_rate')}")
        
        cursor.execute("BEGIN")
        
        for ch in data["channels"]:
            # Ajouter flow_rate dans l'INSERT/UPDATE
            cursor.execute("""
                INSERT INTO device_config (device_id, channel, name, pump_model_id, hmt, flow_rate)
                VALUES ($1, $2, $3, $4, $5, $6)
                ON CONFLICT (device_id, channel) 
                DO UPDATE SET name = $3, pump_model_id = $4, hmt = $5, flow_rate = $6
            """, (
                data["device_id"],
                ch["channel"],
                ch["name"],
                ch.get("pump_model_id"),
                ch.get("hmt", 8),  # hmt existe dÃ©jÃ 
                float(ch["flow_rate"]) if ch.get("flow_rate") else None  # NOUVEAU
            ))
        
        cursor.execute("COMMIT")
        
    except ValueError as e:
        cursor.execute("ROLLBACK")
        raise e
    except Exception as e:
        cursor.execute("ROLLBACK")
        raise e
2ï¸âƒ£ Modifier get_devices_config()
Ajouter flow_rate dans le SELECT :
cursor.execute("""
    SELECT 
        dc.device_id,
        dc.channel,
        dc.name,
        dc.pump_model_id,
        dc.hmt,
        dc.flow_rate,    -- NOUVEAU
        pm.name as pump_name,
        pm.power_kw,
        pm.current_ampere,
        pm.flow_rate_hmt8
    FROM device_config dc
    LEFT JOIN pump_models pm ON dc.pump_model_id = pm.id
    ORDER BY dc.device_id, dc.channel
""")

# Dans la construction de la rÃ©ponse :
channel_info = {
    "channel": row[1],
    "name": row[2],
    "pump_model_id": row[3],
    "hmt": row[4],
    "flow_rate": row[5]  # NOUVEAU
}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ BACKEND - ROUTES (api/routes.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ajouter gestion ValueError si pas dÃ©jÃ  fait :
@app.post("/api/config/device")
async def update_device_config(data: dict):
    conn = get_db_connection()
    try:
        config_service.update_device_config(conn, data)
        return {"success": True, "message": "Configuration enregistrÃ©e"}
    except ValueError as e:
        return JSONResponse(
            status_code=400,
            content={"success": False, "error": str(e)}
        )
    except Exception as e:
        return JSONResponse(
            status_code=500,
            content={"success": False, "error": "Erreur serveur"}
        )
    finally:
        conn.close()
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¨ FRONTEND - PAGE /admin (web/admin.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1ï¸âƒ£ MODIFIER HTML : Ajouter SEULEMENT colonne DÃ©bit effectif
<style>
    .invalid-input {
        border: 2px solid #dc3545 !important;
        background-color: #fff5f5 !important;
    }
</style>

<!-- EntÃªtes colonnes (modifier pour ajouter DÃ©bit effectif) -->
<div style="display: flex; gap: 10px; margin-bottom: 5px; font-size: 12px; color: #666; font-weight: bold;">
    <div style="width: 100px;"></div>
    <div style="flex: 1;">Nom</div>
    <div style="flex: 3;">ModÃ¨le</div>
    <div style="width: 90px; text-align: center;">HMT (m)</div>
    <div style="width: 130px; text-align: center;">DÃ©bit effectif (mÂ³/h)</div>  <!-- NOUVEAU -->
</div>

<!-- Ligne channel (exemple switch:0) -->
<div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
    <label style="width: 100px; font-weight: bold;">switch:0:</label>
    
    <input type="text" id="ch0-name" 
           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    
    <select id="ch0-model" 
            style="flex: 3; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">-- Aucun modÃ¨le --</option>
    </select>
    
    <input type="number" id="ch0-hmt" 
           style="width: 90px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    
    <!-- NOUVEAU CHAMP -->
    <input type="number" id="ch0-flow" step="0.1" min="0" 
           placeholder="DÃ©bit effectif"
           title="DÃ©bit effectif de cette installation (mÂ³/h)"
           style="width: 130px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
</div>

<!-- RÃ©pÃ©ter pour switch:1 et switch:2 -->
2ï¸âƒ£ MODIFIER JAVASCRIPT
<script>
// Format select (modifier pour "si HMT 8")
function formatPumpOption(pump) {
  let info = `${pump.name} (${pump.power_kw} kW, ${pump.current_ampere} A`;
  
  if (pump.flow_rate_hmt8) {
    info += `, ${pump.flow_rate_hmt8} mÂ³/h si HMT 8`;  // MODIFIER
  }
  
  info += ')';
  return info;
}

// Charger config actuelle (ajouter flow_rate)
async function loadCurrentConfig() {
    const response = await fetch('/api/config/devices');
    const devices = await response.json();
    
    devices.forEach(device => {
        device.channels.forEach((ch, idx) => {
            document.getElementById(`ch${idx}-name`).value = ch.name;
            
            if (ch.pump_model_id) {
                document.getElementById(`ch${idx}-model`).value = ch.pump_model_id;
            }
            
            if (ch.hmt) {
                document.getElementById(`ch${idx}-hmt`).value = ch.hmt;
            }
            
            // NOUVEAU
            if (ch.flow_rate) {
                document.getElementById(`ch${idx}-flow`).value = ch.flow_rate;
            }
        });
    });
}

// Validation
function validateNumericInput(inputId) {
    const input = document.getElementById(inputId);
    const value = input.value;
    
    if (value !== '' && isNaN(parseFloat(value))) {
        input.classList.add('invalid-input');
        return false;
    } else {
        input.classList.remove('invalid-input');
        return true;
    }
}

// Sauvegarde (ajouter flow_rate)
async function saveDeviceConfig(deviceId) {
    const channels = [
        {
            channel: 'switch:0',
            name: document.getElementById('ch0-name').value,
            pump_model_id: document.getElementById('ch0-model').value || null,
            hmt: document.getElementById('ch0-hmt').value,
            flow_rate: document.getElementById('ch0-flow').value  // NOUVEAU
        },
        {
            channel: 'switch:1',
            name: document.getElementById('ch1-name').value,
            pump_model_id: document.getElementById('ch1-model').value || null,
            hmt: document.getElementById('ch1-hmt').value,
            flow_rate: document.getElementById('ch1-flow').value  // NOUVEAU
        },
        {
            channel: 'switch:2',
            name: document.getElementById('ch2-name').value,
            pump_model_id: document.getElementById('ch2-model').value || null,
            hmt: document.getElementById('ch2-hmt').value,
            flow_rate: document.getElementById('ch2-flow').value  // NOUVEAU
        }
    ];
    
    // Validation flow_rate SEULEMENT
    for (let i = 0; i < channels.length; i++) {
        const ch = channels[i];
        const channelName = ch.name || `switch:${i}`;
        
        if (ch.flow_rate !== '' && isNaN(parseFloat(ch.flow_rate))) {
            alert(`âŒ Erreur : DÃ©bit effectif du channel "${channelName}" doit Ãªtre un nombre valide`);
            document.getElementById(`ch${i}-flow`).focus();
            document.getElementById(`ch${i}-flow`).classList.add('invalid-input');
            return;
        }
        
        // Convertir
        ch.hmt = ch.hmt === '' ? 8 : parseFloat(ch.hmt);
        ch.flow_rate = ch.flow_rate === '' ? null : parseFloat(ch.flow_rate);
    }
    
    // Envoi
    const response = await fetch('/api/config/device', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: deviceId,
            device_name: document.getElementById('device-name').value,
            channels: channels
        })
    });
    
    if (response.ok) {
        alert('âœ… Configuration enregistrÃ©e avec succÃ¨s !');
    } else {
        const error = await response.json();
        alert('âŒ Erreur : ' + (error.error || 'Erreur inconnue'));
    }
}

// Validation temps rÃ©el
document.addEventListener('DOMContentLoaded', function() {
    loadPumpModels();
    
    for (let i = 0; i < 3; i++) {
        document.getElementById(`ch${i}-flow`).addEventListener('input', function() {
            validateNumericInput(`ch${i}-flow`);
        });
    }
});
</script>
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… CHECKLIST POST-BUILD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Base de donnÃ©es :
â˜ Colonne flow_rate ajoutÃ©e Ã  device_config (REAL NULL)
â˜ Colonne hmt NON MODIFIÃ‰E (existe dÃ©jÃ )
Backend :
â˜ update_device_config() : validation flow_rate ajoutÃ©e
â˜ update_device_config() : flow_rate dans SQL INSERT/UPDATE
â˜ get_devices_config() : flow_rate dans SELECT
â˜ get_devices_config() : flow_rate dans rÃ©ponse JSON
Frontend :
â˜ EntÃªte colonne "DÃ©bit effectif (mÂ³/h)" ajoutÃ©e
â˜ Champ input flow_rate ajoutÃ© pour chaque channel
â˜ Format select modifiÃ© : "X mÂ³/h si HMT 8"
â˜ JavaScript : flow_rate dans saveDeviceConfig()
â˜ JavaScript : validation flow_rate avant envoi
â˜ JavaScript : flow_rate prÃ©-rempli dans loadCurrentConfig()
â˜ JavaScript : validation temps rÃ©el sur flow_rate
â˜ Style CSS : .invalid-input
Tests :
â˜ Saisir flow_rate = 22 pour switch:0 â†’ EnregistrÃ©
â˜ Recharger page â†’ flow_rate prÃ©-rempli
â˜ Saisir "abc" dans flow_rate â†’ Erreur + champ rouge
â˜ Laisser flow_rate vide â†’ OK (NULL en BDD)
â˜ Select affiche : "Pedrollo VXM 10/35 (0.75 kW, 4.8 A, 18 mÂ³/h si HMT 8)"

---

## ğŸ¯ RÃ‰SUMÃ‰

### **UNIQUEMENT ajoutÃ©** :
- âœ… Colonne `flow_rate` dans `device_config`
- âœ… Champ "DÃ©bit effectif (mÂ³/h)" dans formulaire
- âœ… Validation flow_rate (frontend + backend)
- âœ… Format select : "si HMT 8" (au lieu de "@ HMT 8m")

### **NON modifiÃ©** :
- âŒ Colonne `hmt` (existe dÃ©jÃ , ne pas toucher)
- âŒ Champ HMT dans formulaire (existe dÃ©jÃ )
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ CONFIGURATION CUSTOM DOMAIN POUR REPLIT WEBSOCKET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ OBJECTIF
Configurer un domaine personnalisÃ© pour le serveur Replit afin de contourner
la protection "replshield" qui bloque les connexions WebSocket depuis 
Cloudflare Worker.

ğŸ”§ PRÃ‰REQUIS
- AccÃ¨s Ã  Cloudflare DNS (compte filtreplante.com)
- AccÃ¨s au Replit "shelly-ws-collector-sagemcom"
- AccÃ¨s au Worker Cloudflare "shelly-filter-proxy"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ã‰TAPE 1 : CONFIGURATION REPLIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1.1 Ouvrir le Replit "shelly-ws-collector-sagemcom"

1.2 Aller dans les paramÃ¨tres :
    - Cliquer sur l'icÃ´ne âš™ï¸ (Settings) en haut Ã  droite
    - Ou aller dans l'onglet "Deployments"

1.3 Trouver la section "Custom Domains" ou "Domains"

1.4 Ajouter le domaine personnalisÃ© :
    Domaine suggÃ©rÃ© : shelly-collector.filtreplante.com
    
1.5 Replit va vous donner des instructions DNS (type CNAME)
    âš ï¸ NOTER CES INFORMATIONS - Vous en aurez besoin pour l'Ã©tape 2

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ã‰TAPE 2 : CONFIGURATION CLOUDFLARE DNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

2.1 Se connecter Ã  Cloudflare Dashboard

2.2 SÃ©lectionner le domaine "filtreplante.com"

2.3 Aller dans l'onglet "DNS" â†’ "Records"

2.4 Ajouter un nouvel enregistrement :
    Type : CNAME
    Name : shelly-collector
    Target : [valeur fournie par Replit - gÃ©nÃ©ralement *.replit.app ou replit.dev]
    Proxy status : DNS only (gris, PAS orange)
    TTL : Auto
    
    âš ï¸ IMPORTANT : Le proxy Cloudflare (orange) DOIT Ãªtre DÃ‰SACTIVÃ‰
    pour que les WebSockets fonctionnent correctement

2.5 Cliquer "Save"

2.6 Attendre la propagation DNS (1-5 minutes gÃ©nÃ©ralement)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ã‰TAPE 3 : VÃ‰RIFICATION DNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

3.1 Ouvrir un terminal local

3.2 Tester la rÃ©solution DNS :
    nslookup shelly-collector.filtreplante.com
    
    OU
    
    dig shelly-collector.filtreplante.com

3.3 VÃ©rifier que le domaine pointe vers l'infrastructure Replit

3.4 Tester la connexion HTTPS :
    curl https://shelly-collector.filtreplante.com
    
    Devrait retourner la rÃ©ponse de votre serveur Replit

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ã‰TAPE 4 : MISE Ã€ JOUR WORKER CLOUDFLARE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

4.1 Aller dans Cloudflare Dashboard â†’ Workers & Pages

4.2 Ouvrir le Worker "shelly-filter-proxy"

4.3 Aller dans "Settings" â†’ "Variables"

4.4 Option A - Ajouter/Modifier la variable d'environnement :
    Name : REPLIT_WS_URL
    Value : wss://shelly-collector.filtreplante.com/ws
    
    Option B - Modifier directement dans le code :
    const backendUrl = 
      (env.REPLIT_WS_URL && String(env.REPLIT_WS_URL)) ||
      "wss://shelly-collector.filtreplante.com/ws";

4.5 DÃ©ployer la nouvelle version du Worker

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ã‰TAPE 5 : TESTS ET VALIDATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

5.1 VÃ©rifier les logs du Worker Cloudflare :
    - Aller dans "Observability" â†’ "Real-time Logs"
    - DÃ©clencher une pompe pour gÃ©nÃ©rer un message >10W
    - Chercher : "ğŸ”„ Attempting connection to:"
    - VÃ©rifier : "âœ… Backend connected successfully!"

5.2 VÃ©rifier les logs du serveur Replit :
    - Chercher : "ğŸ”— Nouvelle connexion WebSocket"
    - VÃ©rifier l'IP/origine de la connexion

5.3 VÃ©rifier la base de donnÃ©es :
    - Se connecter au Replit
    - Ouvrir la console psql ou l'interface DB
    - RequÃªte : SELECT * FROM shelly_data ORDER BY timestamp DESC LIMIT 5;
    - VÃ©rifier que de nouvelles donnÃ©es arrivent

5.4 Test complet :
    - ArrÃªter toutes les pompes (donnÃ©es â‰¤10W)
    - VÃ©rifier logs Worker : "ğŸ”½ 100 messages filtered"
    - DÃ©marrer une pompe (>10W)
    - VÃ©rifier logs Worker : "âš¡ Message >10W detected!"
    - VÃ©rifier logs Worker : "Sent to Replit"
    - VÃ©rifier DB : Nouvelles entrÃ©es avec timestamp rÃ©cent

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ProblÃ¨me : "Backend connection error" dans logs Worker

Solution 1 : VÃ©rifier que le proxy Cloudflare est DÃ‰SACTIVÃ‰ (gris)
  â†’ Dans Cloudflare DNS, Ã©diter l'enregistrement CNAME
  â†’ Cliquer sur le nuage orange pour le rendre gris
  â†’ Sauvegarder

Solution 2 : VÃ©rifier le certificat SSL/TLS
  â†’ Le domaine doit avoir un certificat valide
  â†’ Replit gÃ©nÃ¨re automatiquement un certificat Let's Encrypt
  â†’ Attendre 5-10 minutes aprÃ¨s ajout du domaine

Solution 3 : VÃ©rifier l'URL WebSocket
  â†’ Doit commencer par wss:// (pas ws://)
  â†’ Doit se terminer par /ws (votre endpoint WebSocket)
  â†’ Format : wss://shelly-collector.filtreplante.com/ws

ProblÃ¨me : DNS ne se rÃ©sout pas

Solution :
  â†’ Attendre propagation DNS (jusqu'Ã  24h max, souvent 5-15 min)
  â†’ Vider le cache DNS local : ipconfig /flushdns (Windows) ou 
    sudo dscacheutil -flushcache (Mac)
  â†’ Tester avec un autre rÃ©seau ou 4G pour contourner le cache

ProblÃ¨me : "replshield" redirect toujours prÃ©sent

Solution :
  â†’ VÃ©rifier que le domaine personnalisÃ© est bien activÃ© dans Replit
  â†’ RedÃ©ployer l'application Replit
  â†’ S'assurer que le domaine pointe vers le bon dÃ©ploiement

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RÃ‰SULTAT ATTENDU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… URL stable et professionnelle
âœ… Pas de protection replshield
âœ… Connexions WebSocket fonctionnelles Worker â†’ Replit
âœ… DonnÃ©es Shelly arrivent en base de donnÃ©es
âœ… Logs Worker montrent connexions rÃ©ussies
âœ… Logs Replit montrent rÃ©ception des messages
âœ… Solution pÃ©renne (URL ne change jamais)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DURÃ‰E ESTIMÃ‰E : 15-30 MINUTES (+ temps de propagation DNS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
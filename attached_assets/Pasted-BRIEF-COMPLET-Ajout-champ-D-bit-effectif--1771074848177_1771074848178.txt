BRIEF COMPLET : Ajout champ "DÃ©bit effectif"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ OBJECTIF
Ajouter un champ "DÃ©bit effectif (mÂ³/h)" dans la configuration de chaque channel,
permettant de saisir le dÃ©bit rÃ©el mesurÃ© ou calculÃ© pour l'installation spÃ©cifique.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š BASE DE DONNÃ‰ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MODIFICATION TABLE device_config
---------------------------------
Ajouter colonne flow_rate :

```sql
ALTER TABLE device_config ADD COLUMN IF NOT EXISTS flow_rate REAL NULL;
Structure finale de device_config :
device_id (TEXT)
channel (TEXT)
name (TEXT) â† Ex: "PR1"
pump_model_id (INTEGER) â† ModÃ¨le de pompe
hmt (REAL) â† HMT de cette installation (dÃ©faut 8)
flow_rate (REAL NULL) â† NOUVEAU : DÃ©bit effectif de cette installation
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ BACKEND - SERVICE (config_service.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1ï¸âƒ£ Modifier update_device_config()
def update_device_config(conn, data):
    cursor = conn.cursor()
    
    try:
        # Validation des donnÃ©es
        for ch in data["channels"]:
            # Valider HMT
            if ch.get("hmt") is not None:
                try:
                    hmt = float(ch["hmt"])
                    if hmt < 0:
                        raise ValueError(f"HMT doit Ãªtre positif pour {ch['channel']}")
                except (ValueError, TypeError):
                    raise ValueError(f"HMT invalide pour {ch['channel']}: {ch.get('hmt')}")
            
            # Valider flow_rate (dÃ©bit effectif)
            if ch.get("flow_rate") is not None and ch.get("flow_rate") != "":
                try:
                    flow_rate = float(ch["flow_rate"])
                    if flow_rate < 0:
                        raise ValueError(f"DÃ©bit effectif doit Ãªtre positif pour {ch['channel']}")
                except (ValueError, TypeError):
                    raise ValueError(f"DÃ©bit effectif invalide pour {ch['channel']}: {ch.get('flow_rate')}")
        
        # Insertion si validation OK
        cursor.execute("BEGIN")
        
        for ch in data["channels"]:
            cursor.execute("""
                INSERT INTO device_config (device_id, channel, name, pump_model_id, hmt, flow_rate)
                VALUES ($1, $2, $3, $4, $5, $6)
                ON CONFLICT (device_id, channel) 
                DO UPDATE SET name = $3, pump_model_id = $4, hmt = $5, flow_rate = $6
            """, (
                data["device_id"],
                ch["channel"],
                ch["name"],
                ch.get("pump_model_id"),
                float(ch["hmt"]) if ch.get("hmt") else 8,
                float(ch["flow_rate"]) if ch.get("flow_rate") else None
            ))
        
        cursor.execute("COMMIT")
        
    except ValueError as e:
        cursor.execute("ROLLBACK")
        raise e
    except Exception as e:
        cursor.execute("ROLLBACK")
        raise e
2ï¸âƒ£ Modifier get_devices_config()
Ajouter flow_rate dans le SELECT et la rÃ©ponse :
def get_devices_config(conn):
    cursor = conn.cursor()
    
    cursor.execute("""
        SELECT 
            dc.device_id,
            dc.channel,
            dc.name,
            dc.pump_model_id,
            dc.hmt,
            dc.flow_rate,
            pm.name as pump_name,
            pm.power_kw,
            pm.current_ampere,
            pm.flow_rate_hmt8
        FROM device_config dc
        LEFT JOIN pump_models pm ON dc.pump_model_id = pm.id
        ORDER BY dc.device_id, dc.channel
    """)
    
    devices = {}
    for row in cursor.fetchall():
        device_id = row[0]
        if device_id not in devices:
            devices[device_id] = {
                "device_id": device_id,
                "device_name": "...",  # Ã€ adapter selon ton code existant
                "channels": []
            }
        
        channel_info = {
            "channel": row[1],
            "name": row[2],
            "pump_model_id": row[3],
            "hmt": row[4],
            "flow_rate": row[5]  # NOUVEAU
        }
        
        if row[3]:  # Si pump_model_id existe
            channel_info["pump_model"] = {
                "id": row[3],
                "name": row[6],
                "power_kw": row[7],
                "current_ampere": row[8],
                "flow_rate_hmt8": row[9]
            }
        
        devices[device_id]["channels"].append(channel_info)
    
    return list(devices.values())
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ BACKEND - ROUTES (api/routes.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Modifier la gestion des erreurs pour update_device_config :
@app.post("/api/config/device")
async def update_device_config(data: dict):
    conn = get_db_connection()
    try:
        config_service.update_device_config(conn, data)
        return {"success": True, "message": "Configuration enregistrÃ©e"}
    except ValueError as e:
        return JSONResponse(
            status_code=400,
            content={"success": False, "error": str(e)}
        )
    except Exception as e:
        return JSONResponse(
            status_code=500,
            content={"success": False, "error": "Erreur serveur"}
        )
    finally:
        conn.close()
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¨ FRONTEND - PAGE /admin (web/admin.py)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1ï¸âƒ£ MODIFIER render_admin() : HTML
Ajouter entÃªtes de colonnes ET champs flow_rate :
<!-- Style pour champs invalides -->
<style>
    .invalid-input {
        border: 2px solid #dc3545 !important;
        background-color: #fff5f5 !important;
    }
</style>

<!-- EntÃªtes des colonnes (au-dessus de la premiÃ¨re ligne de channels) -->
<div style="display: flex; gap: 10px; margin-bottom: 5px; font-size: 12px; color: #666; font-weight: bold;">
    <div style="width: 100px;"></div>
    <div style="flex: 1;">Nom</div>
    <div style="flex: 3;">ModÃ¨le</div>
    <div style="width: 90px; text-align: center;">HMT (m)</div>
    <div style="width: 130px; text-align: center;">DÃ©bit effectif (mÂ³/h)</div>
</div>

<!-- Channel switch:0 -->
<div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
    <label style="width: 100px; font-weight: bold;">switch:0:</label>
    
    <input type="text" id="ch0-name" value="PR1" 
           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    
    <select id="ch0-model" 
            style="flex: 3; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">-- Aucun modÃ¨le --</option>
    </select>
    
    <input type="number" id="ch0-hmt" value="8" step="0.5" min="0" 
           placeholder="HMT"
           style="width: 90px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    
    <input type="number" id="ch0-flow" step="0.1" min="0" 
           placeholder="DÃ©bit effectif"
           title="DÃ©bit effectif de cette installation (mÂ³/h)"
           style="width: 130px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
</div>

<!-- RÃ©pÃ©ter pour switch:1 et switch:2 -->

<button class="btn-save" onclick="saveDeviceConfig('shellypro4pm-...')">
    Enregistrer
</button>
2ï¸âƒ£ MODIFIER render_admin() : JAVASCRIPT
<script>
let pumpModels = [];

// Format des options du select (avec "si HMT 8")
function formatPumpOption(pump) {
  let info = `${pump.name} (${pump.power_kw} kW, ${pump.current_ampere} A`;
  
  if (pump.flow_rate_hmt8) {
    info += `, ${pump.flow_rate_hmt8} mÂ³/h si HMT 8`;
  }
  
  info += ')';
  return info;
}

// Charger les modÃ¨les de pompes
async function loadPumpModels() {
    const response = await fetch('/api/config/pump-models');
    pumpModels = await response.json();
    
    ['ch0-model', 'ch1-model', 'ch2-model'].forEach(selectId => {
        const select = document.getElementById(selectId);
        pumpModels.forEach(pump => {
            const option = document.createElement('option');
            option.value = pump.id;
            option.textContent = formatPumpOption(pump);
            select.appendChild(option);
        });
    });
    
    loadCurrentConfig();
}

// Charger la configuration actuelle
async function loadCurrentConfig() {
    const response = await fetch('/api/config/devices');
    const devices = await response.json();
    
    devices.forEach(device => {
        // Update device name
        // ... ton code existant
        
        device.channels.forEach((ch, idx) => {
            document.getElementById(`ch${idx}-name`).value = ch.name;
            
            if (ch.pump_model_id) {
                document.getElementById(`ch${idx}-model`).value = ch.pump_model_id;
            }
            
            if (ch.hmt) {
                document.getElementById(`ch${idx}-hmt`).value = ch.hmt;
            }
            
            // NOUVEAU : DÃ©bit effectif
            if (ch.flow_rate) {
                document.getElementById(`ch${idx}-flow`).value = ch.flow_rate;
            }
        });
    });
}

// Validation d'un champ numÃ©rique
function validateNumericInput(inputId, fieldName) {
    const input = document.getElementById(inputId);
    const value = input.value;
    
    if (value !== '' && isNaN(parseFloat(value))) {
        input.classList.add('invalid-input');
        return false;
    } else {
        input.classList.remove('invalid-input');
        return true;
    }
}

// Sauvegarde de la configuration
async function saveDeviceConfig(deviceId) {
    // RÃ©cupÃ©rer les valeurs
    const channels = [
        {
            channel: 'switch:0',
            name: document.getElementById('ch0-name').value,
            pump_model_id: document.getElementById('ch0-model').value || null,
            hmt: document.getElementById('ch0-hmt').value,
            flow_rate: document.getElementById('ch0-flow').value
        },
        {
            channel: 'switch:1',
            name: document.getElementById('ch1-name').value,
            pump_model_id: document.getElementById('ch1-model').value || null,
            hmt: document.getElementById('ch1-hmt').value,
            flow_rate: document.getElementById('ch1-flow').value
        },
        {
            channel: 'switch:2',
            name: document.getElementById('ch2-name').value,
            pump_model_id: document.getElementById('ch2-model').value || null,
            hmt: document.getElementById('ch2-hmt').value,
            flow_rate: document.getElementById('ch2-flow').value
        }
    ];
    
    // VALIDATION
    for (let i = 0; i < channels.length; i++) {
        const ch = channels[i];
        const channelName = ch.name || `switch:${i}`;
        
        // Valider HMT
        if (ch.hmt !== '' && isNaN(parseFloat(ch.hmt))) {
            alert(`âŒ Erreur : HMT du channel "${channelName}" doit Ãªtre un nombre valide`);
            document.getElementById(`ch${i}-hmt`).focus();
            document.getElementById(`ch${i}-hmt`).classList.add('invalid-input');
            return;
        }
        
        // Valider DÃ©bit effectif
        if (ch.flow_rate !== '' && isNaN(parseFloat(ch.flow_rate))) {
            alert(`âŒ Erreur : DÃ©bit effectif du channel "${channelName}" doit Ãªtre un nombre valide`);
            document.getElementById(`ch${i}-flow`).focus();
            document.getElementById(`ch${i}-flow`).classList.add('invalid-input');
            return;
        }
        
        // Convertir en nombre ou null
        ch.hmt = ch.hmt === '' ? 8 : parseFloat(ch.hmt);
        ch.flow_rate = ch.flow_rate === '' ? null : parseFloat(ch.flow_rate);
    }
    
    // Envoi
    const response = await fetch('/api/config/device', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            device_id: deviceId,
            device_name: document.getElementById('device-name').value,
            channels: channels
        })
    });
    
    if (response.ok) {
        alert('âœ… Configuration enregistrÃ©e avec succÃ¨s !');
    } else {
        const error = await response.json();
        alert('âŒ Erreur : ' + (error.error || 'Erreur inconnue'));
    }
}

// Validation temps rÃ©el
document.addEventListener('DOMContentLoaded', function() {
    loadPumpModels();
    
    // Ajouter Ã©couteurs pour validation temps rÃ©el
    for (let i = 0; i < 3; i++) {
        document.getElementById(`ch${i}-hmt`).addEventListener('input', function() {
            validateNumericInput(`ch${i}-hmt`, 'HMT');
        });
        
        document.getElementById(`ch${i}-flow`).addEventListener('input', function() {
            validateNumericInput(`ch${i}-flow`, 'DÃ©bit effectif');
        });
    }
});
</script>
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… CHECKLIST POST-BUILD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Base de donnÃ©es :
â˜ Colonne flow_rate ajoutÃ©e Ã  device_config (REAL NULL)
Backend :
â˜ update_device_config() : validation HMT et flow_rate
â˜ update_device_config() : insertion flow_rate dans SQL
â˜ get_devices_config() : SELECT flow_rate
â˜ get_devices_config() : retourne flow_rate dans rÃ©ponse
â˜ Route POST /api/config/device : gestion ValueError
Frontend :
â˜ EntÃªtes colonnes ajoutÃ©es
â˜ Champ "DÃ©bit effectif (mÂ³/h)" pour chaque channel (width: 130px)
â˜ Format select : "X mÂ³/h si HMT 8"
â˜ JavaScript : flow_rate inclus dans saveDeviceConfig()
â˜ JavaScript : validation avant envoi (isNaN)
â˜ JavaScript : flow_rate prÃ©-rempli dans loadCurrentConfig()
â˜ JavaScript : validation temps rÃ©el (input event)
â˜ Style CSS : .invalid-input (bordure rouge + background rose)
Tests :
â˜ CrÃ©er config avec flow_rate = 22 pour switch:0 â†’ EnregistrÃ©
â˜ Recharger page â†’ flow_rate = 22 prÃ©-rempli
â˜ Saisir "abc" dans flow_rate â†’ Erreur affichÃ©e, champ rouge
â˜ Saisir "15.5" dans flow_rate â†’ Validation OK, champ normal
â˜ Laisser flow_rate vide â†’ Enregistrement OK (NULL en BDD)
â˜ VÃ©rifier BDD : SELECT flow_rate FROM device_config â†’ Valeur correcte
â˜ Menu dÃ©roulant affiche : "Pedrollo VXM 10/35 (0.75 kW, 4.8 A, 18 mÂ³/h si HMT 8)"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ EXEMPLE FINAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Configuration visible dans /admin :
          Nom    ModÃ¨le                                              HMT   DÃ©bit effectif
switch:0:   [PR1]  [Pedrollo VXM 10/35 (0.75 kW, 4.8 A, 18 mÂ³/h si HMT 8) â–¼]  [6]   [22]
switch:1:   [PR2]  [Pedrollo VXM 10/35 (0.75 kW, 4.8 A, 18 mÂ³/h si HMT 8) â–¼]  [8]   [18]
switch:2:   [PS]   [Pedrollo DM/8 (0.55 kW, 3.2 A) â–¼]                         [8]   []
[Enregistrer]
AprÃ¨s enregistrement :
switch:0 : HMT=6, flow_rate=22 (pompÃ© sur site avec moins de hauteur)
switch:1 : HMT=8, flow_rate=18 (correspond au dÃ©bit de rÃ©fÃ©rence constructeur)
switch:2 : HMT=8, flow_rate=NULL (pas de dÃ©bit renseignÃ©)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ POINTS D'ATTENTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VALIDATION DOUBLE
Frontend (UX rapide) + Backend (sÃ©curitÃ©)
FORMAT MENU DÃ‰ROULANT
"18 mÂ³/h si HMT 8" (pas "@ HMT 8m")
CHAMP OPTIONNEL
flow_rate peut Ãªtre NULL (non renseignÃ©)
FEEDBACK VISUEL
Bordure rouge + background rose si invalide
Retour Ã  normal dÃ¨s correction
VALEURS PAR DÃ‰FAUT
HMT = 8 si non renseignÃ©
flow_rate = NULL si non renseignÃ©